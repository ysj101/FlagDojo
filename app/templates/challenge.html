{% extends "base.html" %}

{% block title %}{{ challenge.title }} - FlagDojo{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Challenge Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start mb-4">
            <h1 class="text-3xl font-bold text-gray-900">{{ challenge.title }}</h1>
            {% if solved %}
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-md text-sm font-medium">✓ Solved</span>
            {% endif %}
        </div>
        
        <div class="flex gap-3 mb-4">
            <span class="difficulty-{{ challenge.difficulty }} px-3 py-1 rounded-md text-sm font-medium border">
                {{ challenge.difficulty|capitalize }}
            </span>
            <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-md text-sm font-medium">
                {{ challenge.category }}
            </span>
            <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-md text-sm font-medium">
                {{ challenge.points }} points
            </span>
        </div>
        
        <div class="prose max-w-none">
            <p class="text-gray-700">{{ challenge.description }}</p>
        </div>
    </div>

    <!-- Challenge Interface -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Challenge</h2>
        <a href="{{ url_for('challenge_' + challenge.slug + '.index') }}" 
           target="_blank"
           class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded-md text-sm font-medium transition-colors">
            Open Challenge →
        </a>
        <p class="text-gray-600 text-sm mt-2">The challenge will open in a new tab</p>
    </div>

    <!-- Flag Submission -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Submit Flag</h2>
        <form id="flagForm" class="space-y-4">
            <div>
                <input type="text" 
                       id="flagInput" 
                       name="flag" 
                       placeholder="FLAG{...}" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                       required>
            </div>
            <button type="submit" 
                    class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-md font-medium transition-colors">
                Submit Flag
            </button>
        </form>
        <div id="flagResult" class="mt-4"></div>
    </div>

    <!-- Hints -->
    {% if hints %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Hints</h2>
        {% for hint in hints %}
        <details class="mb-2">
            <summary class="cursor-pointer text-indigo-600 hover:text-indigo-800 font-medium">
                Hint {{ loop.index }}
            </summary>
            <p class="mt-2 text-gray-700 pl-4">{{ hint }}</p>
        </details>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Recent Submissions -->
    {% if submissions %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Your Recent Submissions</h2>
        <div class="space-y-2">
            {% for submission in submissions %}
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                <span class="text-gray-600 text-sm font-mono">{{ submission.submitted_flag }}</span>
                <span class="{% if submission.is_correct %}text-green-600{% else %}text-red-600{% endif %} text-sm font-medium">
                    {% if submission.is_correct %}✓ Correct{% else %}✗ Incorrect{% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('flagForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const flagInput = document.getElementById('flagInput');
    const resultDiv = document.getElementById('flagResult');
    const flag = flagInput.value.trim();
    
    if (!flag) {
        resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-3 text-red-800 text-sm">Please enter a flag</div>';
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("core.submit_flag") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                challenge_slug: '{{ challenge.slug }}',
                flag: flag
            })
        });
        
        const data = await response.json();
        
        if (data.correct) {
            resultDiv.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-md p-3 text-green-800 text-sm">${data.message}</div>`;
            if (data.first_solve) {
                setTimeout(() => location.reload(), 2000);
            }
        } else {
            resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-md p-3 text-red-800 text-sm">${data.message}</div>`;
        }
        
        flagInput.value = '';
    } catch (error) {
        resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-3 text-red-800 text-sm">Error submitting flag. Please try again.</div>';
    }
});
</script>
{% endblock %}
